# PersonaPlex iOS 实时语音通话应用架构设计方案

> 设计时间：2026-01-27
> 目标：在本地局域网内，使用 iPhone 与 PersonaPlex 模型进行实时语音交流
> 服务端环境：CentOS 9 + NVIDIA A5000
> 客户端环境：iPhone + iOS 17+

---

## 一、系统概述

### 1.1 目标定义

构建一个 iOS 原生应用，实现：
- **实时全双工语音对话**：用户可以随时说话、打断，模型实时响应
- **低延迟交互**：端到端延迟控制在 500ms 以内
- **局域网部署**：iPhone 与服务器在同一局域网内通信
- **角色定制**：支持自定义 Voice Prompt 和 Text Prompt

### 1.2 核心挑战

| 挑战 | 说明 | 解决思路 |
|------|------|----------|
| **全双工通信** | 同时收发音频流 | WebSocket 双向通信 |
| **低延迟音频** | 实时录音+播放 | AVAudioEngine + 环形缓冲区 |
| **音频编解码** | 高效压缩传输 | Opus 编解码器 |
| **网络抖动** | 音频播放断续 | Jitter Buffer 缓冲策略 |
| **SSL/HTTPS** | 浏览器麦克风权限 | 自签名证书 + 局域网 DNS |

---

## 二、整体架构

### 2.1 系统架构图

```text

┌──────────────────────────────────────────────────────────────────────┐
│                          局域网 (LAN)                                 │
│                                                                      │
│  ┌─────────────────────┐              ┌─────────────────────────────┐│
│  │    iPhone 客户端     │   WebSocket  │      CentOS 9 服务器         ││
│  │                     │   (WSS)      │                             ││
│  │  ┌───────────────┐  │◄────────────►│  ┌───────────────────────┐  ││
│  │  │   iOS App     │  │   Opus Audio │  │  PersonaPlex Server   │  ││
│  │  │               │  │              │  │                       │  ││
│  │  │ ┌───────────┐ │  │              │  │ ┌───────────────────┐ │  ││
│  │  │ │ 音频采集   │ │  │     ───►     │  │ │    Moshi Engine   │ │  ││
│  │  │ │AVAudioEng.│ │  │              │  │ │                   │ │  ││
│  │  │ └───────────┘ │  │              │  │ │ ┌───────────────┐ │ │  ││
│  │  │       │       │  │              │  │ │ │ PersonaPlex   │ │ │  ││
│  │  │       ▼       │  │              │  │ │ │   7B Model    │ │ │  ││
│  │  │ ┌───────────┐ │  │              │  │ │ └───────────────┘ │ │  ││
│  │  │ │ Opus编码   │ │  │              │  │ │                   │ │  ││
│  │  │ │ 24kHz/16b │ │  │              │  │ │ ┌───────────────┐ │ │  ││
│  │  │ └───────────┘ │  │              │  │ │ │  Mimi Codec   │ │ │  ││
│  │  │       │       │  │              │  │ │ │  (Neural)     │ │ │  ││
│  │  │       ▼       │  │              │  │ │ └───────────────┘ │ │  ││
│  │  │ ┌───────────┐ │  │              │  │ └───────────────────┘ │  ││
│  │  │ │ WebSocket │ │  │     ◄───     │  │                       │  ││
│  │  │ │  Client   │ │  │              │  └───────────────────────┘  ││
│  │  │ └───────────┘ │  │              │                             ││
│  │  │       │       │  │              │  ┌───────────────────────┐  ││
│  │  │       ▼       │  │              │  │     NVIDIA A5000      │  ││
│  │  │ ┌───────────┐ │  │              │  │       24GB VRAM       │  ││
│  │  │ │ Opus解码   │ │  │              │  └───────────────────────┘  ││
│  │  │ └───────────┘ │  │              │                             ││
│  │  │       │       │  │              │                             ││
│  │  │       ▼       │  │              │                             ││
│  │  │ ┌───────────┐ │  │              │                             ││
│  │  │ │ 音频播放   │ │  │              │                             ││
│  │  │ │AVAudioEng.│ │  │              │                             ││
│  │  │ └───────────┘ │  │              │                             ││
│  │  └───────────────┘  │              │                             ││
│  └─────────────────────┘              └─────────────────────────────┘│
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流图

```text

┌─────────────────────────────────────────────────────────────────────┐
│                        全双工数据流                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  上行（用户语音 → 模型）                                              │
│  ┌──────┐    ┌──────┐    ┌───────┐    ┌─────────┐    ┌──────────┐  │
│  │ 麦克风│ →  │ PCM  │ →  │ Opus  │ →  │WebSocket│ →  │PersonaPlex│  │
│  │ 24kHz│    │Buffer│    │Encode │    │  Send   │    │  Process │  │
│  └──────┘    └──────┘    └───────┘    └─────────┘    └──────────┘  │
│                                                                     │
│  下行（模型响应 → 用户）                                              │
│  ┌──────────┐    ┌─────────┐    ┌───────┐    ┌──────┐    ┌──────┐  │
│  │PersonaPlex│ → │WebSocket│ →  │ Opus  │ →  │Jitter│ →  │ 扬声器│  │
│  │ Generate │    │ Receive │    │Decode │    │Buffer│    │ 24kHz│  │
│  └──────────┘    └─────────┘    └───────┘    └──────┘    └──────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、通信协议设计

### 3.1 WebSocket 协议规范

PersonaPlex（基于 Moshi）使用 **Opus 编码的二进制音频帧** 通过 WebSocket 进行双向流式传输。

#### 3.1.1 连接参数

| 参数 | 值 | 说明 |
|------|-----|------|
| **协议** | WSS (WebSocket Secure) | 必须使用 HTTPS |
| **端口** | 8998 | PersonaPlex 默认端口 |
| **路径** | `/ws` 或 `/` | 根据服务端配置 |

#### 3.1.2 音频格式

| 参数 | 值 | 说明 |
|------|-----|------|
| **采样率** | 24000 Hz | Mimi Codec 标准 |
| **位深** | 16-bit | 有符号整数 |
| **声道** | 单声道 (Mono) | |
| **编码** | Opus | 低延迟模式 |
| **帧时长** | 20ms | 480 samples/frame |

#### 3.1.3 消息格式

```text

┌──────────────────────────────────────┐
│           WebSocket 消息              │
├──────────────────────────────────────┤
│ 类型：Binary (Opus 音频帧)             │
│ 大小：~50-100 bytes/frame (20ms)      │
│ 方向：双向（客户端 ↔ 服务器）            │
└──────────────────────────────────────┘
```

### 3.2 会话生命周期

```text

┌─────────────────────────────────────────────────────────────────┐
│                       会话状态机                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌──────────┐                                                  │
│   │  IDLE    │ ── 用户点击"开始对话" ──►   ┌──────────────┐       │
│   │ (空闲)    │                          │ CONNECTING   │       │
│   └──────────┘                           │ (连接中)      │       │
│        ▲                                 └──────┬───────┘       │
│        │                                        │               │
│   连接断开                               WebSocket 连接成功       │
│        │                                        │               │
│        │                                        ▼               │
│   ┌──────────┐                           ┌──────────────┐       │
│   │  ERROR   │ ◄── 错误/超时 ──────────── │  STREAMING   │       │
│   │ (错误)   │                           │  (对话中)     │       │
│   └──────────┘                           └──────┬───────┘      │
│                                                 │              │
│                                          用户点击"结束"          │
│                                                 │              │
│                                                 ▼              │
│                                          ┌──────────────┐      │
│                                          │ DISCONNECTED │      │
│                                          │  (已断开)     │      │
│                                          └──────────────┘       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、iOS 客户端架构

### 4.1 模块划分

```text

┌─────────────────────────────────────────────────────────────────┐
│                    iOS App 模块架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Presentation Layer                   │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │    │
│  │  │ MainView    │  │ SettingsView│  │ WaveformView    │  │    │
│  │  │ (SwiftUI)   │  │ (SwiftUI)   │  │ (实时波形显示)    │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Business Layer                       │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │              VoiceChatManager                   │    │    │
│  │  │  - 协调音频采集、编解码、网络通信                    │    │    │
│  │  │  - 管理会话状态                                   │    │    │
│  │  │  - 处理错误和重连                                 │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Infrastructure Layer                 │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │    │
│  │  │AudioManager │  │ OpusCodec   │  │ WebSocketClient │  │    │
│  │  │             │  │             │  │                 │  │    │
│  │  │-录音         │  │-Opus编码    │  │-WSS连接管理      │  │    │
│  │  │-播放         │  │-Opus解码    │  │-消息收发         │  │    │
│  │  │-音频会话     │  │-重采样       │  │-心跳/重连        │  │    │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 核心类设计

#### 4.2.1 VoiceChatManager (业务协调层)

```text

┌─────────────────────────────────────────────────────────────────┐
│                     VoiceChatManager                            │
├─────────────────────────────────────────────────────────────────┤
│ Properties:                                                     │
│   - state: ChatState (idle/connecting/streaming/error)          │
│   - serverURL: URL                                              │
│   - voicePrompt: String                                         │
│   - textPrompt: String                                          │
│                                                                 │
│ Dependencies:                                                   │
│   - audioManager: AudioManager                                  │
│   - opusCodec: OpusCodec                                        │
│   - webSocket: WebSocketClient                                  │
│                                                                 │
│ Methods:                                                        │
│   + startConversation()                                         │
│   + stopConversation()                                          │
│   + configure(server:voicePrompt:textPrompt:)                   │
│                                                                 │
│ Callbacks:                                                      │
│   + onStateChange: (ChatState) -> Void                          │
│   + onError: (Error) -> Void                                    │
│   + onAudioLevel: (Float) -> Void  // 用于波形显示               │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.2.2 AudioManager (音频处理层)

```text

┌─────────────────────────────────────────────────────────────────┐
│                       AudioManager                              │
├─────────────────────────────────────────────────────────────────┤
│ Properties:                                                     │
│   - audioEngine: AVAudioEngine                                  │
│   - inputNode: AVAudioInputNode                                 │
│   - playerNode: AVAudioPlayerNode                               │
│   - sampleRate: 24000                                           │
│   - bufferSize: 480 (20ms frame)                                │
│                                                                 │
│ Recording:                                                      │
│   + startRecording(onBuffer: (AVAudioPCMBuffer) -> Void)        │
│   + stopRecording()                                             │
│                                                                 │
│ Playback:                                                       │
│   + scheduleBuffer(_ buffer: AVAudioPCMBuffer)                  │
│   + startPlayback()                                             │
│   + stopPlayback()                                              │
│                                                                 │
│ Session:                                                        │
│   + configureAudioSession()                                     │
│   + handleInterruption(_ notification: Notification)            │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.2.3 OpusCodec (编解码层)

```text

┌─────────────────────────────────────────────────────────────────┐
│                        OpusCodec                                │
├─────────────────────────────────────────────────────────────────┤
│ Configuration:                                                  │
│   - sampleRate: 24000                                           │
│   - channels: 1                                                 │
│   - application: .voip (低延迟模式)                              │
│   - frameSize: 480 (20ms)                                       │
│                                                                 │
│ Encoder:                                                        │
│   - opusEncoder: OpaquePointer                                  │
│   + encode(pcmBuffer: Data) -> Data?                            │
│                                                                 │
│ Decoder:                                                        │
│   - opusDecoder: OpaquePointer                                  │
│   + decode(opusPacket: Data) -> AVAudioPCMBuffer?               │
│                                                                 │
│ Note: 使用 swift-opus 库 (github.com/alta/swift-opus)            │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.2.4 WebSocketClient (网络层)

```
┌─────────────────────────────────────────────────────────────────┐
│                     WebSocketClient                              │
├─────────────────────────────────────────────────────────────────┤
│ Properties:                                                     │
│   - urlSession: URLSession                                      │
│   - webSocketTask: URLSessionWebSocketTask                      │
│   - isConnected: Bool                                           │
│                                                                 │
│ Connection:                                                     │
│   + connect(to url: URL)                                        │
│   + disconnect()                                                │
│                                                                 │
│ Messaging:                                                      │
│   + send(data: Data)  // 发送 Opus 音频帧                        │
│   + receive() async -> Data?                                    │
│                                                                 │
│ Callbacks:                                                      │
│   + onConnected: () -> Void                                     │
│   + onDisconnected: (Error?) -> Void                            │
│   + onMessage: (Data) -> Void                                   │
│                                                                 │
│ Note: 使用 iOS 原生 URLSessionWebSocketTask                      │
│       支持 WSS (WebSocket Secure)                               │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 音频处理流水线

```text

┌─────────────────────────────────────────────────────────────────┐
│                     音频录制流水线 (上行)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────────┐     ┌────────────┐     ┌────────────────────┐   │
│  │  麦克风     │     │ AVAudioEngine │   │   InputNode Tap   │   │
│  │  硬件       │ ──► │ 音频会话       │ ──► │   安装采样回调     │   │
│  └────────────┘     └────────────┘     └─────────┬──────────┘   │
│                                                  │              │
│                                          AVAudioPCMBuffer      │
│                                          (可能是 44.1kHz)       │
│                                                  │              │
│                                                  ▼              │
│                                        ┌────────────────────┐   │
│                                        │   重采样到 24kHz    │   │
│                                        │   (AVAudioConverter)│   │
│                                        └─────────┬──────────┘   │
│                                                  │              │
│                                          PCM 24kHz/16bit       │
│                                                  │              │
│                                                  ▼              │
│                                        ┌────────────────────┐   │
│                                        │    Opus 编码       │   │
│                                        │   (20ms frame)     │   │
│                                        └─────────┬──────────┘   │
│                                                  │              │
│                                          Opus 数据包           │
│                                          (~50-100 bytes)       │
│                                                  │              │
│                                                  ▼              │
│                                        ┌────────────────────┐   │
│                                        │  WebSocket 发送    │   │
│                                        │  (Binary Message)  │   │
│                                        └────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     音频播放流水线 (下行)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────────────────┐                                         │
│  │  WebSocket 接收    │                                         │
│  │  (Binary Message)  │                                         │
│  └─────────┬──────────┘                                         │
│            │                                                    │
│      Opus 数据包                                                 │
│            │                                                    │
│            ▼                                                    │
│  ┌────────────────────┐                                         │
│  │    Opus 解码       │                                         │
│  │   → PCM 24kHz      │                                         │
│  └─────────┬──────────┘                                         │
│            │                                                    │
│     AVAudioPCMBuffer                                            │
│            │                                                    │
│            ▼                                                    │
│  ┌────────────────────┐                                         │
│  │   Jitter Buffer    │  ◄── 关键：平滑网络抖动                   │
│  │   (环形缓冲区)      │      建议缓冲 60-100ms                   │
│  └─────────┬──────────┘                                         │
│            │                                                    │
│            ▼                                                    │
│  ┌────────────────────┐     ┌────────────┐     ┌────────────┐   │
│  │ AVAudioPlayerNode │ ──► │AVAudioEngine│ ──► │   扬声器    │   │
│  │ scheduleBuffer()  │     │   播放      │     │   硬件     │   │
│  └────────────────────┘     └────────────┘     └────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 五、服务端架构

### 5.1 服务部署架构

```text

┌─────────────────────────────────────────────────────────────────┐
│                    CentOS 9 服务器架构                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   Network Layer                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │              NGINX (可选，用于反向代理)           │    │    │
│  │  │  - SSL 终止                                      │    │    │
│  │  │  - 负载均衡 (如果多实例)                          │    │    │
│  │  │  - 静态文件服务                                   │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                 PersonaPlex Server                       │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │              moshi.server (Python)               │    │    │
│  │  │                                                  │    │    │
│  │  │  ┌──────────────┐    ┌──────────────────────┐   │    │    │
│  │  │  │ WebSocket    │    │   Model Inference    │   │    │    │
│  │  │  │ Handler      │◄──►│                      │   │    │    │
│  │  │  │              │    │ ┌──────────────────┐ │   │    │    │
│  │  │  │ - 接收音频    │    │ │  PersonaPlex 7B  │ │   │    │    │
│  │  │  │ - 发送响应    │    │ │  (GPU Memory)    │ │   │    │    │
│  │  │  │ - 会话管理    │    │ └──────────────────┘ │   │    │    │
│  │  │  └──────────────┘    │                      │   │    │    │
│  │  │                      │ ┌──────────────────┐ │   │    │    │
│  │  │  ┌──────────────┐    │ │   Mimi Codec     │ │   │    │    │
│  │  │  │ SSL Context  │    │ │ (Audio Tokenize) │ │   │    │    │
│  │  │  │ (自签名证书)   │    │ └──────────────────┘ │   │    │    │
│  │  │  └──────────────┘    └──────────────────────┘   │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    GPU Layer                             │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │               NVIDIA A5000 (24GB)               │    │    │
│  │  │                                                 │    │    │
│  │  │   模型内存占用: ~14-16 GB                         │    │    │
│  │  │   可用于推理:   ~8-10 GB                          │    │    │
│  │  │                                                 │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 服务启动配置

```bash
# 启动 PersonaPlex 服务器（局域网可访问）
SSL_DIR=$(mktemp -d)
python -m moshi.server \
  --ssl "$SSL_DIR" \
  --host 0.0.0.0 \        # 监听所有网络接口
  --port 8998 \
  --voice-prompt NATF2 \  # 默认声音
  --text-prompt "You are a wise and friendly assistant."
```

---

## 六、关键技术细节

### 6.1 Opus 编解码配置

```text

┌─────────────────────────────────────────────────────────────────┐
│                    Opus 编解码器配置                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  编码器配置:                                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Sample Rate:     24000 Hz                               │    │
│  │ Channels:        1 (Mono)                               │    │
│  │ Application:     OPUS_APPLICATION_VOIP                  │    │
│  │ Frame Duration:  20ms (480 samples)                     │    │
│  │ Bitrate:         24000-32000 bps (VBR)                  │    │
│  │ Complexity:      5-8 (平衡延迟和质量)                    │    │
│  │ Signal Type:     OPUS_SIGNAL_VOICE                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  解码器配置:                                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Sample Rate:     24000 Hz                               │    │
│  │ Channels:        1 (Mono)                               │    │
│  │ FEC:             启用 (网络丢包恢复)                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  推荐 Swift 库: github.com/alta/swift-opus                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 Jitter Buffer 设计

```text

┌─────────────────────────────────────────────────────────────────┐
│                    Jitter Buffer 策略                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  目标: 平滑网络延迟抖动，保证音频连续播放                          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   环形缓冲区设计                          │    │
│  │                                                         │    │
│  │   Buffer Size:  150ms (约 7-8 个 20ms 帧)               │    │
│  │   Min Latency:  60ms  (最少缓冲 3 帧再开始播放)          │    │
│  │   Max Latency:  150ms (超过则加速消费)                   │    │
│  │                                                         │    │
│  │   ┌───┬───┬───┬───┬───┬───┬───┬───┐                    │    │
│  │   │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │  ← 环形队列        │    │
│  │   └───┴───┴───┴───┴───┴───┴───┴───┘                    │    │
│  │     ▲                       ▲                          │    │
│  │     │                       │                          │    │
│  │   写指针                   读指针                        │    │
│  │   (网络接收)              (音频播放)                     │    │
│  │                                                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  异常处理:                                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ 缓冲区空 (Buffer Underrun):                             │    │
│  │   → 播放静音帧                                          │    │
│  │   → 等待缓冲恢复到 min latency                          │    │
│  │                                                         │    │
│  │ 缓冲区满 (Buffer Overrun):                              │    │
│  │   → 丢弃最旧的帧                                        │    │
│  │   → 或加速播放 (Time Stretching, 可选)                  │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 iOS 音频会话配置

```text
┌─────────────────────────────────────────────────────────────────┐
│                 AVAudioSession 配置                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Category:     .playAndRecord                                   │
│  Mode:         .voiceChat                                       │
│  Options:      [.defaultToSpeaker, .allowBluetooth]             │
│                                                                 │
│  关键配置:                                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ // 设置音频会话                                          │    │
│  │ let session = AVAudioSession.sharedInstance()           │    │
│  │ try session.setCategory(                                │    │
│  │     .playAndRecord,                                     │    │
│  │     mode: .voiceChat,                                   │    │
│  │     options: [.defaultToSpeaker, .allowBluetooth]       │    │
│  │ )                                                       │    │
│  │ try session.setPreferredSampleRate(24000)               │    │
│  │ try session.setPreferredIOBufferDuration(0.02)  // 20ms │    │
│  │ try session.setActive(true)                             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  中断处理:                                                       │
│  - 来电时暂停对话                                               │
│  - 其他 App 播放音频时处理                                       │
│  - 插拔耳机时重新配置                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 七、UI/UX 设计建议

### 7.1 主界面布局

```text
┌─────────────────────────────────────────┐
│              PersonaPlex                │ ← 状态栏
├─────────────────────────────────────────┤
│                                         │
│    ┌─────────────────────────────┐      │
│    │                             │      │
│    │      实时波形显示区域        │      │ ← 双通道波形
│    │    (用户 + AI 波形叠加)      │      │    绿色=用户
│    │                             │      │    蓝色=AI
│    └─────────────────────────────┘      │
│                                         │
│    ┌─────────────────────────────┐      │
│    │   对话状态: 正在对话中...    │      │ ← 状态指示
│    │   延迟: 180ms               │      │
│    └─────────────────────────────┘      │
│                                         │
│         ┌─────────────────┐             │
│         │                 │             │
│         │   🎤  按住说话   │             │ ← 主按钮
│         │   (或点击切换)   │             │    支持两种模式
│         │                 │             │
│         └─────────────────┘             │
│                                         │
│    ┌──────┐           ┌──────┐          │
│    │ 设置 │           │ 结束 │          │ ← 辅助按钮
│    └──────┘           └──────┘          │
│                                         │
└─────────────────────────────────────────┘
```

### 7.2 设置界面

```text
┌─────────────────────────────────────────┐
│              ⬅️  设置                    │
├─────────────────────────────────────────┤
│                                         │
│  服务器配置                              │
│  ┌─────────────────────────────────┐    │
│  │ 服务器地址                       │    │
│  │ ┌─────────────────────────────┐ │    │
│  │ │ 192.168.1.100:8998         │ │    │ ← 输入局域网地址
│  │ └─────────────────────────────┘ │    │
│  └─────────────────────────────────┘    │
│                                         │
│  角色设置                                │
│  ┌─────────────────────────────────┐    │
│  │ AI 声音                         │    │
│  │ ┌─────────────────────────────┐ │    │
│  │ │ NATF2 (自然女声)       ▼    │ │    │ ← 下拉选择
│  │ └─────────────────────────────┘ │    │
│  │                                 │    │
│  │ AI 角色 (Text Prompt)           │    │
│  │ ┌─────────────────────────────┐ │    │
│  │ │ You are a wise and         │ │    │ ← 多行输入
│  │ │ friendly assistant...      │ │    │
│  │ └─────────────────────────────┘ │    │
│  └─────────────────────────────────┘    │
│                                         │
│  音频设置                                │
│  ┌─────────────────────────────────┐    │
│  │ 缓冲延迟: 80ms          ────●── │    │ ← 滑块
│  │ 回声消除: ✅ 启用               │    │
│  │ 降噪:     ✅ 启用               │    │
│  └─────────────────────────────────┘    │
│                                         │
│         ┌─────────────────┐             │
│         │      保存       │             │
│         └─────────────────┘             │
│                                         │
└─────────────────────────────────────────┘
```

---

## 八、开发阶段规划

### 8.1 开发里程碑

```text
┌─────────────────────────────────────────────────────────────────┐
│                       开发阶段规划                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Phase 1: 基础框架 (1-2 周)                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ ✓ 项目初始化 (Xcode, SwiftUI)                            │    │
│  │ ✓ 集成 swift-opus 库                                    │    │
│  │ ✓ 实现 WebSocket 客户端                                  │    │
│  │ ✓ 实现基础 UI 框架                                       │    │
│  │ ✓ 服务端 SSL 证书配置                                    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  Phase 2: 音频处理 (1-2 周)                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ ✓ AVAudioEngine 录音实现                                │    │
│  │ ✓ AVAudioEngine 播放实现                                │    │
│  │ ✓ Opus 编码/解码集成                                    │    │
│  │ ✓ 重采样逻辑 (44.1kHz → 24kHz)                          │    │
│  │ ✓ Jitter Buffer 实现                                    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  Phase 3: 集成联调 (1 周)                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ ✓ 端到端通信测试                                        │    │
│  │ ✓ 延迟优化                                              │    │
│  │ ✓ 错误处理和重连逻辑                                     │    │
│  │ ✓ 音频会话中断处理                                       │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  Phase 4: UI 完善 (1 周)                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ ✓ 波形可视化                                            │    │
│  │ ✓ 设置界面                                              │    │
│  │ ✓ 状态指示和动画                                        │    │
│  │ ✓ 深色模式支持                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  Phase 5: 测试和优化 (1 周)                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ ✓ 真机测试                                              │    │
│  │ ✓ 网络稳定性测试                                        │    │
│  │ ✓ 电池消耗优化                                          │    │
│  │ ✓ 内存泄漏检查                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│  预计总周期: 5-7 周                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 技术风险和对策

| 风险 | 影响 | 对策 |
|------|------|------|
| **SSL 证书问题** | iOS 不信任自签名证书 | 使用 `NSAllowsLocalNetworking` 或将证书加入信任 |
| **音频延迟过高** | 体验差 | 调整 Buffer 大小，使用低延迟模式 |
| **WebSocket 断连** | 对话中断 | 实现自动重连机制 |
| **Opus 编解码兼容性** | 音频损坏 | 严格匹配服务端配置 |
| **后台运行限制** | 切换 App 时断开 | 申请后台音频权限 |

---

## 九、依赖和工具

### 9.1 iOS 端依赖

| 依赖 | 用途 | 来源 |
|------|------|------|
| **swift-opus** | Opus 编解码 | github.com/alta/swift-opus (SPM) |
| **AVFoundation** | 音频引擎 | Apple 原生 |
| **Network.framework** | WebSocket | Apple 原生 (iOS 13+) |
| **SwiftUI** | UI 框架 | Apple 原生 |

### 9.2 开发工具

| 工具 | 版本 | 用途 |
|------|------|------|
| **Xcode** | 15.0+ | iOS 开发 IDE |
| **iOS Simulator** | - | 初期调试 |
| **Instruments** | - | 性能分析 |
| **Wireshark** | - | 网络抓包调试 |
| **Charles Proxy** | - | HTTPS 调试 |

---

## 十、附录

### A. PersonaPlex 官方资源

- GitHub: https://github.com/NVIDIA/personaplex
- HuggingFace: https://huggingface.co/nvidia/personaplex-7b-v1
- Research Page: https://research.nvidia.com/labs/adlr/personaplex/
- Discord: https://discord.gg/5jAXrrbwRb

### B. iOS 音频开发资源

- AVAudioEngine 官方文档: https://developer.apple.com/documentation/avfaudio/avaudioengine
- swift-opus 库: https://github.com/alta/swift-opus
- Real-time Audio in Swift: https://nickarner.com/notes/working-with-the-opus-audio-codec-in-swift

### C. 协议参考

- WebSocket RFC 6455: https://tools.ietf.org/html/rfc6455
- Opus Codec: https://opus-codec.org/
- Moshi 架构论文: https://kyutai.org/Moshi.pdf

---

#PersonaPlex #iOS #架构设计 #语音交互 #实时通信 #2026

