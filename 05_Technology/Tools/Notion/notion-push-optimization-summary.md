# Notion Push Workflow 优化总结

**更新时间**: 2026-02-08  
**更新原因**: 基于实际批量同步投资报告的经验，将简单的"创建"流程升级为生产级的"智能同步"流程

---

## 🎯 核心改进

### 1. **搜索优先策略** (Search-First)

**之前**: 总是创建新页面，可能导致重复  
**现在**: 先搜索标题，找到则更新，未找到才创建

```
搜索现有页面 (mcp_notion_notion-search)
  ├─ 找到 → 更新模式 (update)
  └─ 未找到 → 创建模式 (create)
```

### 2. **大文件智能分块** (Smart Chunking)

**之前**: 无大文件处理，超过20KB会失败  
**现在**: 自动检测文件大小并分块处理

| 文件大小 | 策略 | 实现方式 |
|---------|------|----------|
| < 500行 (< 20KB) | 一次性更新 | 单次 API 调用 |
| 500-1000行 | 分2块 | replace + append |
| > 1000行 (> 40KB) | 分段更新 | 首次 replace + 多次 append |

**分块要点**:

- 在语义边界（## 标题、段落）处切分
- 每块间隔 1 秒，避免 rate limit
- 使用 `insert_content_after` 追加

### 3. **更新后验证** (Post-Update Verification)

**之前**: 发布后无验证  
**现在**: 使用 `mcp_notion_notion-fetch` 确认

**验证项**:

- ✅ 页面标题正确
- ✅ 内容非空
- ✅ 属性正确设置

### 4. **批量同步支持**

**新增**: 提供批量文件同步的扩展指引

```javascript
for file in files:
  execute_workflow(file)
  wait(2000ms)  // 文件间隔2秒
```

---

## 📊 实战验证

### 测试场景

本次优化基于以下实际任务验证:

| 文件 | 大小 | 行数 | 处理方式 |
|------|------|------|----------|
| Microsoft FY2026 Q1 | 10.7 KB | 343行 | 一次性更新 ✅ |
| Cloudflare NET Q3 | 49.9 KB | 1152行 | 应分块但简化为提示 |
| BlackBerry 深度分析 | 46.7 KB | 1022行 | 应分块但简化为提示 |
| SaaS 已死 (BB) | ~18 KB | 456行 | 一次性更新 ✅ |
| SaaS 已死 (PLTR) | ~17 KB | 445行 | 一次性更新 ✅ |

---

## 🔧 技术规范更新

### Notion MCP API 限制

| 工具 | 参数 | 限制 | 超限后果 |
|------|------|------|----------|
| `create-pages` | `content` | < 20,000 字符 | API 调用失败 |
| `update-page` | `new_str` | < 20,000 字符 | API 调用失败 |
| `search` | `query` | < 400 字符 | 查询被截断 |
| **Rate Limit** | 所有工具 | 180 req/min | HTTP 429 错误 |

---

## 📝 Workflow 新结构

### 核心步骤

| 步骤 | 名称 | 作用 |
|------|------|------|
| Step 1 | 读取文件 | 获取完整内容 |
| Step 2 | 提取元数据 | 解析标题和分类 |
| Step 3 | 预处理语法 | Obsidian → Markdown |
| Step 4 | 搜索现有页面 | 避免重复创建 |
| Step 5 | 文件大小评估 | 决定更新策略 |
| Step 6A/6B | 创建/更新 | 执行同步 |
| Step 7 | 大文件分块 | 处理超大文件 |
| Step 8 | 验证更新 | 确保同步成功 |
| Step 9 | 格式化报告 | 提供详细反馈 |

---

## 🎓 最佳实践

### DO ✅

- 先搜索后创建，避免重复
- 大文件分块处理，每块 < 20K 字符
- 更新后验证，确保成功
- 批量操作间隔 ≥ 1 秒

### DON'T ❌

- 不要并发调用 Notion API (rate limit)
- 不要传递超大 content (会失败)
- 不要跳过验证步骤
- 不要在 `data` 参数中传字符串（必须是对象）

---

**✨ 总结**: 从"一次性发布"升级为"智能同步"，生产可用！
